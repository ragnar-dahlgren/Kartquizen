<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartquizen</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css?v=24">
    <!-- Open Location Code (Plus Codes) -->
    <script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.2/openlocationcode.min.js"></script>
</head>

<body>

    <div class="app-container">

        <!-- Start Screen -->
        <div id="start-screen" class="glass-panel">
            <h1>Kartquizen</h1>
            <p class="subtitle">Utmana dina v√§nner i geografi</p>

            <div class="join-container">
                <div class="input-group">
                    <input type="text" id="username-input" placeholder="Ditt namn" autocomplete="off">
                </div>
                <div class="input-group">
                    <input type="text" id="room-code-input" placeholder="Rumskod (4 tecken)" autocomplete="off"
                        maxlength="4" style="text-transform:uppercase;">
                </div>
                <button id="join-room-btn" class="btn primary full-width">G√• med i Spel</button>
            </div>

            <!-- Load Quiz Section (For Lekledare) -->
            <div id="load-quiz-section" class="join-container hidden"
                style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                <p style="font-size: 0.9rem; margin-bottom: 10px;">Lekledare</p>
                <div class="input-group">
                    <input type="text" id="quiz-load-code" placeholder="Quiz-ID (t.ex. QUIZ-123)" autocomplete="off">
                </div>
                <button id="load-quiz-btn" class="btn secondary full-width">Ladda Quiz</button>
            </div>

            <div id="status-message" class="status-msg">Ansluter till server...</div>

            <!-- Discreet Host Button -->
            <button id="host-mode-btn" class="btn text-only corner-btn" title="Skapa eget quiz">‚öôÔ∏è Lekledare</button>
        </div>

        <!-- Host Quiz Creator Screen (2-Column Layout) -->
        <div id="host-screen" class="glass-panel hidden wide-panel">
            <div class="host-header">
                <h2>Skapa / Redigera Quiz</h2>
                <div class="header-actions">
                    <button id="back-to-start-btn" class="btn small">‚Üê Hem</button>
                    <button id="test-run-btn" class="btn secondary small">‚ñ∂ Provspela</button>
                </div>
            </div>

            <!-- Tools Row -->
            <div class="save-controls">
                <span id="current-quiz-id">Nytt Quiz (Osparat)</span>
                <button id="save-quiz-btn" class="btn primary small">üíæ Spara Quiz</button>
            </div>

            <div class="host-layout-grid">
                <!-- Left Column: Form -->
                <div class="host-col-form">
                    <h3>Ny Fr√•ga</h3>
                    <div class="question-form">
                        <div class="input-group">
                            <label>Fr√•ga</label>
                            <input type="text" id="q-text" placeholder="T.ex. Var ligger..." autocomplete="off">
                        </div>
                        <div class="input-group">
                            <label>Bild-URL (Frivillig)</label>
                            <input type="text" id="q-image" placeholder="https://..." autocomplete="off">
                        </div>
                        <div class="form-row">
                            <div class="input-group half">
                                <label>Tid (sek)</label>
                                <input type="number" id="q-time" value="30" min="5" max="300">
                            </div>
                        </div>

                        <!-- Plus Code Input -->
                        <div class="form-row">
                            <div class="input-group">
                                <label>Plus Code (Frivillig)</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="q-plus-code" placeholder="T.ex. 9C3XGV00+" style="flex:1;">
                                    <button id="convert-plus-btn" class="btn info small" title="H√§mta plats">üìç</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label>Plats (Lat/Lng)</label>
                                <div class="coords-row">
                                    <input type="text" id="q-lat" placeholder="Lat" class="small-input">
                                    <input type="text" id="q-lng" placeholder="Lng" class="small-input">
                                    <button id="pick-location-btn" class="btn secondary icon-btn">üìç Karta</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button id="add-question-btn" class="btn primary full-width">L√§gg till Fr√•ga</button>
                            <button id="update-question-btn" class="btn success full-width hidden">Uppdatera</button>
                            <button id="cancel-edit-btn" class="btn secondary hidden">Avbryt</button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: List -->
                <div class="host-col-list">
                    <h3>Dina Fr√•gor (<span id="q-count">0</span>)</h3>
                    <div class="questions-list-wrapper">
                        <ul id="questions-list">
                            <!-- List items will be injected here -->
                        </ul>
                    </div>
                    <button id="start-quiz-btn" class="btn success full-width top-margin" disabled>Starta
                        Lobbyn</button>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="glass-panel hidden">
            <h2>Lobby</h2>
            <div class="lobby-info">
                <p>Rumskod:</p>
                <h1 id="lobby-room-code">----</h1>
                <div id="qrcode-container"></div>
            </div>

            <div class="players-list-section">
                <h3>Spelare (<span id="lobby-player-count">0</span>)</h3>
                <ul id="lobby-players-list">
                    <!-- Players go here -->
                </ul>
            </div>

            <div class="lobby-actions">
                <p id="lobby-status-text" class="status-indicator">V√§ntar p√• spelare...</p>
                <button id="lobby-start-btn" class="btn success full-width hidden">Starta Spelet</button>
            </div>
        </div>

        <!-- Game Screen (Map View) -->
        <div id="game-screen" class="hidden">
            <div id="map"></div>

            <!-- Test Controls (Dry Run) -->
            <div id="test-controls" class="overlay-btn hidden"
                style="top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button id="exit-test-btn" class="btn secondary small">‚úñ Avsluta</button>
                <div style="display: flex; gap: 5px;">
                    <button id="prev-test-btn" class="btn primary small">‚Üê</button>
                    <button id="next-test-btn" class="btn primary small">‚Üí</button>
                </div>
            </div>

            <!-- Wait Overlay (Prep Phase) -->
            <div id="wait-overlay" class="game-ui overlay-center hidden">
                <h2 id="wait-text">Laddar fr√•ga...</h2>
                <button id="host-show-question-btn" class="btn success full-width hidden"
                    style="font-size: 1.2rem; margin-top:20px;">Visa Fr√•ga üëÅÔ∏è</button>
            </div>

            <!-- Question Overlay (Preview & Action) -->
            <div id="question-overlay" class="game-ui overlay-top hidden">
                <div class="glass-panel-mini question-box">
                    <h3 id="game-question-text">Laddar fr√•ga...</h3>
                    <div id="game-image-container" class="hidden">
                        <img id="game-question-image" src="" alt="Fr√•gebild">
                    </div>

                    <!-- Timer & Actions -->
                    <div class="timer-bar">
                        <div id="timer-fill"></div>
                    </div>
                    <div id="big-timer"></div>
                    <!-- Old small timer removed from UI, kept in DOM for logic safety if needed or hidden -->
                    <div id="timer-text" class="hidden">30</div>

                    <!-- Host Manual Start Button -->
                    <button id="host-start-round-btn" class="btn success full-width hidden"
                        style="margin-top: 10px; font-size: 1.2rem;">Starta Gissning ‚ñ∂</button>
                </div>
            </div>

            <!-- Feedback Overlay (Result) -->
            <div id="feedback-overlay" class="game-ui overlay-center hidden">
                <h1 id="feedback-text">R√ÑTT!</h1>
                <p id="feedback-subtext">+500 po√§ng</p>

                <!-- Round Summary List (New) -->
                <div id="round-summary-container" class="hidden"
                    style="margin: 15px 0; max-height: 150px; overflow-y: auto; text-align: left; width: 100%;">
                    <ul id="round-results-list" style="list-style: none; padding: 0;"></ul>
                </div>

                <div id="host-result-controls" class="result-controls hidden">
                    <button id="goto-leaderboard-btn" class="btn success full-width">Visa Highscore ‚Üí</button>
                    <!-- Removed Direct Next to enforce flow: Result -> Highscore -> Next -->
                </div>
            </div>

            <!-- Leaderboard Overlay -->
            <div id="leaderboard-overlay" class="glass-panel hidden"
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px;">
                <h2>Po√§ngst√§llning</h2>
                <ul id="live-leaderboard-list" style="list-style: none; text-align: left; padding: 0;">
                    <!-- Leaders go here -->
                </ul>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="next-question-btn" class="btn primary full-width">N√§sta Fr√•ga ‚Üí</button>
                </div>
            </div>

            <!-- Score Overlay REMOVED -->

            <!-- Interaction Overlay -->
            <div id="map-picker-ui" class="overlay-bottom hidden">
                <div class="glass-panel-mini">
                    <p id="picker-instruction">Klicka p√• kartan f√∂r att v√§lja.</p>
                    <button id="confirm-location-btn" class="btn primary">Bekr√§fta Plats</button>
                    <button id="cancel-picker-btn" class="btn secondary">Avbryt</button>
                    <!-- Game specific confirm button -->
                    <button id="submit-guess-btn" class="btn primary hidden">Gissa H√§r!</button>
                </div>
            </div>

            <!-- HOST ACTION BAR (New Fixed Control) -->
            <div id="host-action-bar" class="hidden">
                <div style="display:flex; align-items:center;">
                    <div class="host-badge">üëë Lekledare</div>
                    <button id="host-abort-btn" class="btn secondary small"
                        style="margin-left:10px; padding: 5px 10px; background: rgba(255,50,50,0.3);">Avbryt
                        Spel</button>
                </div>
                <div id="host-action-content">
                    <!-- Dynamic Buttons injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- QRCode JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- App Logic (v33) -->
    <script src="js/script.js?v=33"></script>
</body>

</html>